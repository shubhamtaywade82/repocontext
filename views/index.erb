<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Repo Chat | AI Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked@9/marked.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js" crossorigin="anonymous"></script>
  <style>
    :root {
      /* Palette */
      --bg-dark: #050505;
      --bg-gradient-start: #0a0e17;
      --bg-gradient-end: #000000;

      --glass-surface: rgba(22, 27, 34, 0.6);
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-highlight: rgba(255, 255, 255, 0.03);

      --primary: #58a6ff;
      --primary-glow: rgba(88, 166, 255, 0.4);
      --secondary: #8b949e;

      --success: #3fb950;
      --success-glow: rgba(63, 185, 80, 0.3);
      --error: #f85149;

      --text-main: #f0f6fc;
      --text-muted: #8b949e;
      --text-dim: #484f58;

      /* Spacing & Radius */
      --radius-lg: 24px;
      --radius-md: 16px;
      --radius-sm: 8px;

      --header-height: 70px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Outfit', sans-serif;
      background: var(--bg-dark);
      background: radial-gradient(circle at top left, #1b202c, #050505 60%);
      color: var(--text-main);
      min-height: 100vh;
      overflow: hidden; /* App-like feel */
      display: flex;
      flex-direction: column;
    }

    /* Utilities */
    .glass {
      background: var(--glass-surface);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      box-shadow: 0 4px 24px rgba(0,0,0,0.4);
    }

    .btn-reset { border: none; background: none; cursor: pointer; color: inherit; font-family: inherit; }
    .mono { font-family: 'JetBrains Mono', monospace; }

    /* Layout */
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0;
    }

    @media(min-width: 1024px) {
      .app-container {
        padding: 20px;
      }
      body {
        align-items: center;
        justify-content: center;
      }
      .main-window {
        border-radius: var(--radius-lg);
        overflow: hidden;
        height: 100%;
        max-height: 95vh;
        width: 100%;
        display: flex;
        flex-direction: column;
        background: rgba(13, 17, 23, 0.3);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
      }
    }

    @media(max-width: 1023px) {
      .main-window {
        height: 100%;
        width: 100%;
        display: flex;
        flex-direction: column;
      }
    }

    /* Header */
    .header {
      height: var(--header-height);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      border-bottom: 1px solid var(--glass-border);
      background: rgba(13, 17, 23, 0.4);
      flex-shrink: 0;
      gap: 20px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.25rem;
      font-weight: 600;
      letter-spacing: -0.02em;
    }
    .brand-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary), #a371f7);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      box-shadow: 0 0 15px var(--primary-glow);
    }

    /* Model Selector */
    .model-selector {
      position: relative;
    }

    .model-select {
      background: rgba(18, 23, 33, 0.5);
      border: 1px solid var(--glass-border);
      border-radius: 10px;
      padding: 8px 32px 8px 12px;
      color: var(--text-main);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%238b949e" d="M6 8l-4-4h8z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 10px center;
      min-width: 180px;
    }

    .model-select:hover {
      border-color: var(--primary);
      background-color: rgba(18, 23, 33, 0.7);
    }

    .model-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.15);
    }

    .model-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
    }

    /* Nav Tabs */
    .nav-tabs {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      border: 1px solid var(--glass-border);
    }
    .nav-tab {
      padding: 8px 20px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-muted);
      transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
    }
    .nav-tab:hover { color: var(--text-main); }
    .nav-tab.active {
      background: var(--glass-highlight);
      color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    /* Content Area */
    .content-area {
      flex: 1;
      position: relative;
      overflow: hidden;
      display: flex;
    }

    .panel {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .panel.active {
      display: flex;
      opacity: 1;
      transform: translateY(0);
    }

    /* --- Chat UI --- */
    .chat-layout {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      scroll-behavior: smooth;
    }

    .message {
      max-width: 85%;
      padding: 16px 20px;
      border-radius: 18px;
      line-height: 1.6;
      font-size: 0.95rem;
      position: relative;
      animation: msgFadeIn 0.3s cubic-bezier(0.2, 0.9, 0.4, 1);
    }

    @keyframes msgFadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--primary), #3b82f6);
      color: white;
      border-bottom-right-radius: 4px;
      box-shadow: 0 4px 12px var(--primary-glow);
    }

    .message.assistant {
      align-self: flex-start;
      background: var(--glass-surface);
      border: 1px solid var(--glass-border);
      border-bottom-left-radius: 4px;
    }

    .message-role {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
      opacity: 0.7;
      font-weight: 600;
    }

    /* Markdown Styles */
    .message p { margin: 0 0 0.8em; }
    .message p:last-child { margin: 0; }
    .message pre {
      background: rgba(0,0,0,0.3);
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9em;
      border: 1px solid var(--glass-border);
    }
    .message code {
      background: rgba(0,0,0,0.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9em;
    }

    /* Chat Input */
    .chat-input-area {
      padding: 24px;
      background: linear-gradient(to top, rgba(0,0,0,0.4), transparent 100%);
    }
    .input-wrapper {
      position: relative;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }
    .chat-input {
      width: 100%;
      background: rgba(18, 23, 33, 0.3);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 16px 50px 16px 20px;
      color: white;
      font-family: inherit;
      font-size: 1rem;
      resize: none;
      height: 60px;
      transition: all 0.2s;
    }
    .chat-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.15);
      background: rgba(13, 17, 23, 0.5);
    }
    .send-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .send-btn:hover { transform: translateY(-50%) scale(1.1); box-shadow: 0 0 10px var(--primary-glow); }
    .send-btn:disabled { opacity: 0.5; cursor: default; transform: translateY(-50%); }

    /* Chat Progress & Steps */
    .chat-status-bar {
      margin-top: 12px;
      min-height: 24px;
      display: flex;
      flex-direction: column; /* Changed for step list */
      gap: 4px;
      font-size: 0.85rem;
      color: var(--text-muted);
      background: rgba(13, 17, 23, 0.4);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 12px;
    }


    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid var(--glass-border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* --- Code Review UI --- */
    .review-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      height: 100%;
    }

    @media(max-width: 768px) {
      .review-layout { grid-template-columns: 1fr; grid-template-rows: 240px 1fr; }
    }

    /* Sidebar */
    .review-sidebar {
      background: rgba(13, 17, 23, 0.3);
      border-right: 1px solid var(--glass-border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--glass-border);
    }
    .sidebar-title {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      font-weight: 600;
    }

    .timeline {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .timeline-item {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      position: relative;
      opacity: 0;
      animation: slideRight 0.3s forwards;
      background: rgba(0, 0, 0, 0.2);
      padding: 8px;
      border-radius: 8px;
    }
    .timeline-item:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 24px;
      left: 9px;
      width: 2px;
      height: calc(100% - 4px);
      background: var(--glass-border);
      z-index: 0;
    }

    @keyframes slideRight {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .timeline-icon {
      flex-shrink: 0;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--surface-raised);
      border: 2px solid var(--text-muted);
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      transition: all 0.3s;
    }

    .timeline-item.active .timeline-icon {
      border-color: var(--primary);
      box-shadow: 0 0 10px var(--primary-glow);
      animation: pulse 2s infinite;
    }
    .timeline-item.done .timeline-icon {
      border-color: var(--success);
      background: var(--success);
      color: white;
    }

    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(88,166,255,0.4); } 70% { box-shadow: 0 0 0 6px rgba(0,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); } }

    .timeline-content {
      flex: 1;
      padding-top: 1px;
    }
    .timeline-label { font-size: 0.9rem; font-weight: 500; color: var(--text-main); }
    .timeline-detail { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }

    .timeline-item.pending { opacity: 0.5; animation: none; opacity: 0.5; }
    .timeline-item.pending .timeline-icon { border-style: dashed; background: transparent; box-shadow: none; animation: none; color: transparent; }


    /* Main Review Area */
    .review-main {
      padding: 30px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .config-card {
      padding: 24px;
      border-radius: var(--radius-md);
    }

    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-muted); }
    .form-input {
      width: 100%;
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--glass-border);
      padding: 12px;
      border-radius: 12px;
      color: var(--text-main);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      transition: 0.2s;
    }
    .form-input:focus { outline: none; border-color: var(--primary); }

    .btn-primary {
      background: var(--primary);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      transition: 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary:hover { filter: brightness(1.1); box-shadow: 0 4px 12px var(--primary-glow); }
    .btn-primary:disabled { opacity: 0.5; filter: grayscale(1); }

    /* Findings */
    .finding-card {
      margin-top: 20px;
      border-left: 4px solid var(--text-muted);
      padding: 16px 24px;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
    }
    .finding-card.error { border-left-color: var(--error); }
    .finding-card.warning { border-left-color: #d29922; }

    .finding-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .finding-rule { font-weight: 700; color: var(--text-main); }
    .finding-path { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--text-muted); }

    /* Suggestions */
    .suggestions-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
      animation: msgFadeIn 0.5s ease-out 0.2s both;
    }
    .suggestion-chip {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 0.85rem;
      color: var(--text-main);
      cursor: pointer;
      transition: all 0.2s;
    }
    .suggestion-chip:hover {
      background: var(--glass-highlight);
      border-color: var(--primary);
    }
  </style>
</head>
<body>

<div class="app-container">
  <div class="main-window">

    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <div class="brand">
          <div class="brand-icon">AI</div>
          <span>RepoContext</span>
        </div>
        <div class="model-selector">
          <label class="model-label">Model</label>
          <select id="modelSelect" class="model-select">
            <option value="" selected>Loading models...</option>
          </select>
        </div>
      </div>
      <nav class="nav-tabs">
        <button class="btn-reset nav-tab active" data-target="chat">Chat</button>
        <button class="btn-reset nav-tab" data-target="review">Code Review</button>
      </nav>
    </header>

    <!-- Content -->
    <div class="content-area">

      <!-- Chat Panel -->
      <section id="panel-chat" class="panel active">
        <div class="chat-layout">
          <div class="chat-messages" id="chatMessages">
            <div class="message assistant">
              <div class="message-role">System</div>
              <p>Welcome! I'm ready to answer questions about your codebase or help you review code.</p>
              <% if defined?(suggested_questions) && suggested_questions.any? %>
                <div class="suggestions-container">
                  <% suggested_questions.each do |q| %>
                    <button class="btn-reset suggestion-chip" onclick="useSuggestion(this)"><%= q %></button>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>

          <div class="chat-input-area">
            <div class="input-wrapper">
              <div class="chat-status-bar" id="chatStatus" style="display:none;">
                <span class="spinner"></span> <span id="chatStatusText">Processing...</span>
              </div>
              <textarea id="chatInput" class="chat-input" placeholder="Ask a question about the repo..." rows="1"></textarea>
              <button id="chatSendBtn" class="btn-reset send-btn">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"></path></svg>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Review Panel -->
      <section id="panel-review" class="panel">
        <div class="review-layout">
          <!-- Sidebar / Timeline -->
          <aside class="review-sidebar">
            <div class="sidebar-header">
              <span class="sidebar-title">Review Progress</span>
            </div>
            <div class="timeline" id="reviewTimeline">
              <div class="timeline-item done">
                <div class="timeline-icon">✓</div>
                <div class="timeline-content">
                  <div class="timeline-label">Ready</div>
                  <div class="timeline-detail">Waiting to start</div>
                </div>
              </div>
            </div>
          </aside>

          <!-- Main Config / Results -->
          <main class="review-main" id="reviewMain">
            <div class="glass config-card">
              <div class="form-group">
                <label>Target Paths (Optional)</label>
                <input type="text" id="reviewPaths" class="form-input" placeholder="e.g. lib/core/, app/models/user.rb">
              </div>
              <div class="form-group">
                <label>Review Focus</label>
                <input type="text" id="reviewFocus" class="form-input" placeholder="e.g. Security, Performance, Clean Code">
              </div>
              <button id="runReviewBtn" class="btn-reset btn-primary">
                <span>Start Review Agent</span>
              </button>
            </div>

            <div id="reviewResultsArea"></div>
          </main>
        </div>
      </section>

    </div>
  </div>
</div>

<script>
  // -- Utilities --
  const $ = id => document.getElementById(id);
  const escapeHtml = s => {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  };

  // -- Load Available Models --
  async function loadModels() {
    const modelSelect = $('modelSelect');
    try {
      const resp = await fetch('/api/models');
      const data = await resp.json();

      if (data.models && data.models.length > 0) {
        modelSelect.innerHTML = '';
        data.models.forEach((model, index) => {
          const option = document.createElement('option');
          option.value = model.name;
          option.textContent = model.display_name || model.name;
          if (index === 0) option.selected = true;
          modelSelect.appendChild(option);
        });
      }
    } catch (err) {
      console.error('Failed to load models:', err);
      // Keep the default option if fetch fails
    }
  }

  // Load models on page load
  loadModels();

  // -- Tabs --
  document.querySelectorAll('.nav-tab').forEach(t => {
    t.addEventListener('click', () => {
      document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      $(`panel-${t.dataset.target}`).classList.add('active');
    });
  });

  // -- Chat Logic --
  const chatMessages = $('chatMessages');
  const chatInput = $('chatInput');
  const chatSendBtn = $('chatSendBtn');
  const chatStatus = $('chatStatus');
  const chatStatusText = $('chatStatusText');
  let chatHistory = [];

  function useSuggestion(btn) {
    const text = btn.innerText;
    chatInput.value = text;
    sendChat();
  }

  function appendChatMsg(role, text) {
    const div = document.createElement('div');
    div.className = `message ${role}`;

    // Parse Markdown if assistant
    let contentHtml = escapeHtml(text);
    if (role === 'assistant' && typeof marked !== 'undefined') {
       contentHtml = DOMPurify.sanitize(marked.parse(text));
    } else {
       // Simple formatting for user
       contentHtml = `<p>${contentHtml}</p>`;
    }

    div.innerHTML = `
      <div class="message-role">${role === 'user' ? 'You' : 'Assistant'}</div>
      <div class="message-body">${contentHtml}</div>
    `;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  async function sendChat() {
    const txt = chatInput.value.trim();
    if (!txt) return;

    const selectedModel = $('modelSelect').value;
    chatInput.value = '';
    appendChatMsg('user', txt);

    chatStatus.style.display = 'flex';
    chatStatus.innerHTML = ''; // Clear previous status
    chatSendBtn.disabled = true;

    // Helper to add timeline item to chat status
    const addChatStep = (msg, state='done') => {
      const div = document.createElement('div');
      div.className = `timeline-item ${state}`;
      div.style.marginBottom = '8px';
      // Mini timeline style override for chat
      div.innerHTML = `
        <div class="timeline-icon" style="width:16px;height:16px;font-size:8px;">${state === 'done' ? '✓' : ''}</div>
        <div class="timeline-content" style="padding-top:0">
          <div class="timeline-label" style="font-size:0.8rem">${escapeHtml(msg)}</div>
        </div>
      `;
      chatStatus.appendChild(div);
      return div;
    };

    let lastStep = null;

    try {
      const resp = await fetch('/api/chat/stream', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ message: txt, history: chatHistory, model: selectedModel })
      });

      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop() || '';

        for (const line of lines) {
          if (!line.trim()) continue;
          try {
            const data = JSON.parse(line);
            if (data.event === 'status') {
              if (lastStep) {
                 lastStep.classList.remove('active');
                 lastStep.classList.add('done');
                 lastStep.querySelector('.timeline-icon').innerText = '✓';
              }
              lastStep = addChatStep(data.message, 'active');
            } else if (data.event === 'done') {
              chatStatus.style.display = 'none';
              appendChatMsg('assistant', data.response);
              if (data.history) chatHistory = data.history;
            } else if (data.event === 'error') {
              if (lastStep) {
                 lastStep.classList.remove('active');
                 lastStep.classList.add('error');
              }
              addChatStep('Error: ' + data.error, 'error');
            }
          } catch(e) {}
        }
      }
    } catch (err) {
      addChatStep('Network Error', 'error');
    } finally {
      chatSendBtn.disabled = false;
    }
  }

  chatSendBtn.addEventListener('click', sendChat);
  chatInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendChat();
    }
  });

  // -- Review Logic --
  const startReviewBtn = $('runReviewBtn');
  const reviewTimeline = $('reviewTimeline');
  const reviewResultsArea = $('reviewResultsArea');

  function addTimelineItem(label, detail, state='active') {
    const div = document.createElement('div');
    div.className = `timeline-item ${state}`;
    div.innerHTML = `
      <div class="timeline-icon">${state === 'done' ? '✓' : ''}</div>
      <div class="timeline-content">
        <div class="timeline-label">${escapeHtml(label)}</div>
        <div class="timeline-detail">${escapeHtml(detail)}</div>
      </div>
    `;
    reviewTimeline.appendChild(div);
    reviewTimeline.scrollTop = reviewTimeline.scrollHeight;
    return div;
  }

  function markLastTimelineDone() {
    const items = reviewTimeline.querySelectorAll('.timeline-item.active');
    if (items.length > 0) {
      const last = items[items.length - 1];
      last.classList.remove('active');
      last.classList.add('done');
      last.querySelector('.timeline-icon').innerText = '✓';
    }
  }

  async function runReview() {
    const paths = $('reviewPaths').value.split(',').map(s=>s.trim()).filter(Boolean);
    const focus = $('reviewFocus').value.trim();
    const selectedModel = $('modelSelect').value;

    startReviewBtn.disabled = true;
    reviewTimeline.innerHTML = '';
    reviewResultsArea.innerHTML = '';

    addTimelineItem('Initialize', 'Starting review agent...', 'done');

    try {
      const resp = await fetch('/api/review/stream', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ paths, focus, model: selectedModel })
      });

      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop() || '';

        for (const line of lines) {
          if (!line.trim()) continue;
          try {
            const data = JSON.parse(line);

            if (data.event === 'init') {
                reviewTimeline.innerHTML = ''; // Clear "Initialize"
                addTimelineItem('Planning', 'Review plan initialized', 'done');
                // metrics or summary could go here
                if (data.paths && Array.isArray(data.paths)) {
                  data.paths.forEach(p => {
                    const el = addTimelineItem(p.split('/').pop(), 'Pending...', 'pending');
                    el.dataset.fullPath = p;
                  });
                }
            } else if (data.event === 'status') {
               // Only add a generic status item if it's planning/summarizing, OR update the last active item if appropriate
               // For now, let's keep it simple: if "Planning step", maybe flash the Planning item?
               // Or if just "Planning..", ignore to avoid clutter, or add a transient item.
               // Let's rely on the specific file events for main progress.
               // If it's a "Planning step X", we might not want to log it if we have a file list.
               // But let's show it if it's not a file review.
               if (!data.message.includes('Planning step')) {
                 // addTimelineItem('Status', data.message, 'active');
               }
            } else if (data.event === 'error') {
               markLastTimelineDone();
               addTimelineItem('Error', data.error, 'error');
               const errorCard = document.createElement('div');
               errorCard.className = 'finding-card error';
               errorCard.innerHTML = `<div class="finding-header"><span class="finding-rule">Error</span></div><div>${escapeHtml(data.error)}</div>`;
               reviewResultsArea.appendChild(errorCard);
            } else if (data.event === 'review_file') {
               markLastTimelineDone();
               // Find existing pending item
               const shortName = data.path.split('/').pop();
               let el = Array.from(reviewTimeline.children).find(child => child.dataset.fullPath === data.path);

               if (el) {
                 el.classList.remove('pending');
                 el.classList.add('active');
                 el.querySelector('.timeline-detail').innerText = 'Reviewing...';
                 // scrollTo
                 el.scrollIntoView({ behavior: 'smooth', block: 'center' });
               } else {
                 // Fallback if not found (e.g. planner chose something else)
                 el = addTimelineItem('Reviewing', shortName, 'active');
                 el.dataset.fullPath = data.path;
               }
            } else if (data.event === 'findings') {
               // Update the currently active file to done
               const items = reviewTimeline.querySelectorAll('.timeline-item.active');
               if (items.length > 0) {
                 const last = items[items.length - 1];
                 last.classList.remove('active');
                 last.classList.add('done');
                 last.querySelector('.timeline-icon').innerText = '✓';

                 const count = data.findings ? data.findings.length : 0;
                 last.querySelector('.timeline-detail').innerText = count > 0 ? `${count} findings` : 'No findings';
               }

               // Render findings
               if (data.findings) {
                 data.findings.forEach(f => {
                   const card = document.createElement('div');
                   card.className = `finding-card ${f.severity || 'warning'}`;
                   card.innerHTML = `
                     <div class="finding-header">
                       <span class="finding-rule">${escapeHtml(f.category || 'Issue')}</span>
                       <span class="finding-path">${escapeHtml(data.path)}:${f.line || '?'}</span>
                     </div>
                     <div>${escapeHtml(f.message)}</div>
                   `;
                   reviewResultsArea.appendChild(card);
                 });
               }
            } else if (data.event === 'summary') {
               const summaryDiv = document.createElement('div');
               summaryDiv.className = 'glass config-card';
               summaryDiv.style.marginTop = '20px';
               summaryDiv.innerHTML = `<h2>Review Summary</h2><div style="line-height:1.6">${DOMPurify.sanitize(marked.parse(data.summary))}</div>`;
               reviewResultsArea.prepend(summaryDiv);
            } else if (data.event === 'done') {
               markLastTimelineDone();
               addTimelineItem('Complete', 'Review finished', 'done');
               startReviewBtn.disabled = false;
            }

          } catch(e) {}
        }
      }

    } catch (e) {
      console.error(e);
      addTimelineItem('Error', 'Stream connection failed: ' + e.message, 'active');
    } finally {
      startReviewBtn.disabled = false;
      markLastTimelineDone();
    }
  }

  startReviewBtn.addEventListener('click', runReview);

</script>
</body>
</html>
