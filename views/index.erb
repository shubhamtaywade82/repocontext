<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Repo Chat Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked@8/marked.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js" crossorigin="anonymous"></script>
  <style>
    :root {
      --bg: #0c0f14;
      --surface: #161b22;
      --surface-raised: #1c2128;
      --border: #30363d;
      --border-subtle: #21262d;
      --primary: #388bfd;
      --primary-hover: #1f6feb;
      --success: #3fb950;
      --success-hover: #2ea043;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --error: #f85149;
      --radius: 12px;
      --radius-sm: 8px;
      --space-xs: 0.25rem;
      --space-sm: 0.5rem;
      --space-md: 1rem;
      --space-lg: 1.5rem;
      --space-xl: 2rem;
      --touch: 44px;
      --content-max: 42rem;
      --header-height: 56px;
    }

    *, *::before, *::after { box-sizing: border-box; }
    html { -webkit-text-size-adjust: 100%; }
    body {
      margin: 0;
      font-family: 'DM Sans', ui-sans-serif, system-ui, -apple-system, sans-serif;
      font-size: clamp(0.9375rem, 2vw, 1rem);
      line-height: 1.5;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    .header {
      flex-shrink: 0;
      min-height: var(--header-height);
      padding: var(--space-md) var(--space-lg);
      background: var(--surface);
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-sm);
    }
    .header__title {
      font-size: clamp(0.875rem, 1.5vw, 0.9375rem);
      font-weight: 500;
      color: var(--text);
      margin: 0;
    }
    .header__title code {
      background: var(--surface-raised);
      padding: 0.125rem 0.375rem;
      border-radius: var(--radius-sm);
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    .tabs {
      flex-shrink: 0;
      display: flex;
      padding: 0 var(--space-lg);
      background: var(--surface);
      border-bottom: 1px solid var(--border-subtle);
      gap: 0;
    }
    .tab {
      flex: 1;
      min-height: var(--touch);
      padding: var(--space-sm) var(--space-md);
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-family: inherit;
      font-size: 0.875rem;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: color 0.15s, border-color 0.15s;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
    @media (min-width: 640px) {
      .tab { flex: 0 1 auto; }
    }

    .panel {
      display: none;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }
    .panel.active { display: flex; }

    /* Chat panel */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-lg);
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
      -webkit-overflow-scrolling: touch;
    }
    .message {
      max-width: min(85%, var(--content-max));
      padding: var(--space-md) var(--space-lg);
      border-radius: var(--radius);
      line-height: 1.55;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .message.user {
      align-self: flex-end;
      background: var(--primary);
      color: #fff;
    }
    .message.assistant {
      align-self: flex-start;
      background: var(--surface-raised);
      border: 1px solid var(--border);
    }
    .message .role {
      display: block;
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0.9;
      margin-bottom: 0.35rem;
      font-weight: 600;
    }
    .message.user .role { color: rgba(255,255,255,0.9); }
    .message .body { display: block; }
    .message .body p { margin: 0 0 0.5em; }
    .message .body p:last-child { margin-bottom: 0; }
    .message .body strong { font-weight: 600; }
    .message .body em { font-style: italic; }
    .message .body code {
      background: var(--surface-raised);
      padding: 0.15em 0.35em;
      border-radius: var(--radius-sm);
      font-size: 0.9em;
    }
    .message .body pre {
      margin: 0.5em 0;
      padding: var(--space-md);
      background: var(--surface-raised);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      overflow-x: auto;
      white-space: pre-wrap;
    }
    .message .body pre code { padding: 0; background: none; }
    .message .body ul, .message .body ol { margin: 0.5em 0; padding-left: 1.5em; }
    .message .body li { margin: 0.25em 0; }
    .message .body a { color: var(--primary); }
    .message .body blockquote { margin: 0.5em 0; padding-left: 1em; border-left: 3px solid var(--border); color: var(--text-muted); }

    .input-area {
      flex-shrink: 0;
      padding: var(--space-lg);
      background: var(--surface);
      border-top: 1px solid var(--border-subtle);
    }
    .input-area .container {
      max-width: var(--content-max);
      margin: 0 auto;
    }
    .input-row {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }
    @media (min-width: 480px) {
      .input-row { flex-direction: row; gap: var(--space-md); }
    }
    #input {
      flex: 1;
      min-height: var(--touch);
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg);
      color: var(--text);
      font-family: inherit;
      font-size: 0.9375rem;
      resize: none;
      max-height: 160px;
      transition: border-color 0.15s;
    }
    #input:focus {
      outline: none;
      border-color: var(--primary);
    }
    #input::placeholder { color: var(--text-muted); }
    #send {
      min-height: var(--touch);
      padding: var(--space-sm) var(--space-lg);
      border: none;
      border-radius: var(--radius-sm);
      background: var(--primary);
      color: #fff;
      font-family: inherit;
      font-weight: 500;
      font-size: 0.9375rem;
      cursor: pointer;
      transition: background 0.15s;
    }
    #send:hover { background: var(--primary-hover); }
    #send:disabled { opacity: 0.6; cursor: not-allowed; }
    #send:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
    @media (min-width: 480px) {
      #send { flex-shrink: 0; }
    }

    .status {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin-top: var(--space-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
    }
    .status.error { color: var(--error); }
    .status .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .progress-steps {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      margin-top: var(--space-xs);
    }
    .progress-steps .step {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
      transition: background 0.2s;
    }
    .progress-steps .step.active { background: var(--primary); }
    .progress-steps .step.done { background: var(--text-muted); }

    .chat-progress-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      margin-top: var(--space-md);
      max-width: var(--content-max);
      margin-left: auto;
      margin-right: auto;
      width: 100%;
    }
    .chat-progress-list[hidden] { display: none !important; }
    .chat-progress-step {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: 0.875rem;
      color: var(--text-muted);
    }
    .chat-progress-step.active { color: var(--text); }
    .chat-progress-step.done { color: var(--text-muted); }
    .chat-progress-step .icon {
      flex-shrink: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chat-progress-step .icon .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    .chat-progress-step.done .icon .check {
      color: var(--success);
      font-weight: 700;
    }

    /* Code Review panel */
    .review-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      padding: 0;
    }
    @media (min-width: 768px) {
      .review-section { flex-direction: row; }
    }
    .review-main {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      padding: var(--space-lg);
    }
    @media (min-width: 640px) {
      .review-main { padding: var(--space-xl); }
    }
    .review-side-panel {
      display: flex;
      flex-direction: column;
      background: var(--surface);
      border-top: 1px solid var(--border-subtle);
      max-height: 16rem;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    @media (min-width: 768px) {
      .review-side-panel {
        width: 20rem;
        max-width: 100%;
        max-height: none;
        border-top: none;
        border-left: 1px solid var(--border-subtle);
        flex-shrink: 0;
      }
    }
    .review-side-panel__title {
      flex-shrink: 0;
      padding: var(--space-md) var(--space-lg);
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border-subtle);
    }
    .review-card {
      max-width: var(--content-max);
      margin: 0 auto;
      width: 100%;
      padding: var(--space-lg);
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius);
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }
    .review-card label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: var(--space-xs);
    }
    .review-card input {
      width: 100%;
      min-height: var(--touch);
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg);
      color: var(--text);
      font-family: inherit;
      font-size: 0.9375rem;
    }
    .review-card input:focus {
      outline: none;
      border-color: var(--primary);
    }
    .review-card input::placeholder { color: var(--text-muted); }
    #runReview {
      min-height: var(--touch);
      padding: var(--space-sm) var(--space-lg);
      border: none;
      border-radius: var(--radius-sm);
      background: var(--success);
      color: #fff;
      font-family: inherit;
      font-weight: 500;
      font-size: 0.9375rem;
      cursor: pointer;
      align-self: flex-start;
      transition: background 0.15s;
    }
    #runReview:hover { background: var(--success-hover); }
    #runReview:disabled { opacity: 0.6; cursor: not-allowed; }
    #runReview:focus-visible { outline: 2px solid var(--success); outline-offset: 2px; }

    .review-status-wrap {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-top: var(--space-md);
      min-height: 1.5rem;
      max-width: var(--content-max);
      width: 100%;
    }
    .review-status-wrap.in-progress .in-progress-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-muted);
      background: var(--surface-raised);
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius-sm);
    }
    .review-status-wrap .in-progress-badge { display: none; }
    .review-status-wrap .status-text { flex: 1; }

    .review-progress-log {
      flex: 1;
      min-height: 0;
      padding: var(--space-sm) var(--space-md);
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }
    .review-side-panel:not([data-has-steps]) { display: none; }
    @media (min-width: 768px) {
      .review-side-panel:not([data-has-steps]) { display: flex; }
    }
    .review-progress-log[hidden] { display: none !important; }
    .review-progress-step {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: 0.8125rem;
      color: var(--text-muted);
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius-sm);
    }
    .review-progress-step.active {
      color: var(--text);
      background: var(--surface-raised);
    }
    .review-progress-step .icon {
      flex-shrink: 0;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .review-progress-step .icon .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    .review-progress-step.done .icon .check { color: var(--success); }
    .review-progress-step .detail { margin-left: auto; font-size: 0.75rem; opacity: 0.9; }

    .review-results {
      flex: 1;
      overflow-y: auto;
      margin-top: var(--space-lg);
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      -webkit-overflow-scrolling: touch;
    }
    .review-results .container {
      max-width: var(--content-max);
      margin: 0 auto;
      width: 100%;
    }
    .review-summary {
      padding: var(--space-lg);
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius);
      white-space: pre-wrap;
      font-size: 0.9375rem;
      line-height: 1.6;
    }
    .review-finding {
      padding: var(--space-md) var(--space-lg);
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      border-left: 4px solid var(--text-muted);
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      border-left-width: 4px;
    }
    .review-finding.error { border-left-color: var(--error); }
    .review-finding.warning { border-left-color: #d29922; }
    .review-finding.suggestion { border-left-color: var(--text-muted); }
    .review-finding .path { color: var(--text-muted); font-size: 0.8125rem; }
    .review-finding .rule { font-weight: 600; color: var(--text); }
  </style>
</head>
<body>
  <header class="header">
    <h1 class="header__title">Repo Chat Assistant — Chat about the codebase or run an agentic code review (plan → review files → summarize). <code>REPO_CONTEXT_PATH</code>, <code>CONTEXT_FILES</code>, <code>OLLAMA_BASE_URL</code>.</h1>
  </header>
  <nav class="tabs" role="tablist">
    <button type="button" class="tab active" role="tab" aria-selected="true" aria-controls="panel-chat" id="tab-chat" data-tab="chat">Chat</button>
    <button type="button" class="tab" role="tab" aria-selected="false" aria-controls="panel-review" id="tab-review" data-tab="review">Code Review</button>
  </nav>
  <section id="panel-chat" class="panel active" role="tabpanel" aria-labelledby="tab-chat">
    <div class="messages" id="messages"></div>
    <div class="input-area">
      <div class="container">
        <div class="input-row">
          <textarea id="input" placeholder="Ask about the codebase..." rows="1" aria-label="Message"></textarea>
          <button type="button" id="send" aria-label="Send">Send</button>
        </div>
        <div class="status" id="status"></div>
        <div class="progress-steps" id="progressSteps" style="display: none;">
          <span class="step" id="step1" title="Gathering context"></span>
          <span class="step" id="step2" title="Asking Ollama"></span>
        </div>
        <ol class="chat-progress-list" id="chatProgressList" hidden aria-live="polite">
          <li class="chat-progress-step" id="chatStep1" data-step="0">
            <span class="icon"><span class="spinner"></span></span>
            <span class="label">Gathering context</span>
          </li>
          <li class="chat-progress-step" id="chatStep2" data-step="1">
            <span class="icon"></span>
            <span class="label">Asking Ollama</span>
          </li>
        </ol>
      </div>
    </div>
  </section>
  <section id="panel-review" class="panel" role="tabpanel" aria-labelledby="tab-review" hidden>
    <div class="review-section">
      <div class="review-main">
        <div class="review-card">
          <label for="reviewPaths">Paths (optional, comma-separated; empty = discover from repo)</label>
          <input type="text" id="reviewPaths" placeholder="e.g. lib/repocontext/chat_service.rb, lib/repocontext/context_builder.rb">
          <label for="reviewFocus">Focus (optional)</label>
          <input type="text" id="reviewFocus" placeholder="e.g. Clean Ruby, naming, single responsibility">
          <button type="button" id="runReview">Run code review</button>
        </div>
        <div class="review-status-wrap" id="reviewStatusWrap">
          <span class="in-progress-badge"><span class="spinner"></span> In progress</span>
          <div class="status status-text" id="reviewStatus"></div>
        </div>
        <div class="review-results" id="reviewResults">
          <div class="container"></div>
        </div>
      </div>
      <aside class="review-side-panel" id="reviewSidePanel" aria-label="Review progress">
        <h2 class="review-side-panel__title">Progress</h2>
        <ol class="review-progress-log" id="reviewProgressLog" hidden aria-live="polite"></ol>
      </aside>
    </div>
  </section>
  <script>
    (function() {
      const messagesEl = document.getElementById('messages');
      const inputEl = document.getElementById('input');
      const sendBtn = document.getElementById('send');
      const statusEl = document.getElementById('status');
      const progressStepsEl = document.getElementById('progressSteps');
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const chatProgressListEl = document.getElementById('chatProgressList');
      const chatStep1El = document.getElementById('chatStep1');
      const chatStep2El = document.getElementById('chatStep2');

      function setStatus(text, isError) {
        statusEl.innerHTML = text ? '<span class="spinner"></span>' + escapeHtml(text) : '';
        statusEl.className = 'status' + (isError ? ' error' : '');
        statusEl.style.display = text ? 'flex' : 'none';
        progressStepsEl.style.display = text && !isError ? 'flex' : 'none';
      }

      function updateChatProgressList(activeIndex) {
        chatProgressListEl.hidden = false;
        [chatStep1El, chatStep2El].forEach(function(el, i) {
          var icon = el.querySelector('.icon');
          el.classList.remove('active', 'done');
          if (i < activeIndex) {
            el.classList.add('done');
            icon.innerHTML = '<span class="check">✓</span>';
          } else if (i === activeIndex) {
            el.classList.add('active');
            icon.innerHTML = '<span class="spinner"></span>';
          } else {
            icon.innerHTML = '';
          }
        });
      }

      function finishChatProgressList() {
        [chatStep1El, chatStep2El].forEach(function(el) {
          el.classList.remove('active');
          el.classList.add('done');
          el.querySelector('.icon').innerHTML = '<span class="check">✓</span>';
        });
        chatProgressListEl.hidden = true;
      }

      function setProgressStep(activeIndex, statusText) {
        progressStepsEl.style.display = 'flex';
        statusEl.style.display = 'flex';
        statusEl.innerHTML = statusText ? '<span class="spinner"></span>' + escapeHtml(statusText) : '';
        step1.className = 'step' + (activeIndex > 0 ? ' done' : ' active');
        step2.className = 'step' + (activeIndex > 1 ? ' done' : activeIndex === 1 ? ' active' : '');
        updateChatProgressList(activeIndex);
      }

      function renderMarkdown(text) {
        if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
          marked.setOptions({ gfm: true, breaks: true });
          var raw = marked.parse(text || '');
          return DOMPurify.sanitize(raw, { ALLOWED_TAGS: ['p','br','strong','em','code','pre','ul','ol','li','a','blockquote','h1','h2','h3','h4','span'] });
        }
        return escapeHtml(text);
      }

      function appendMessage(role, content) {
        const div = document.createElement('div');
        div.className = 'message ' + role;
        const label = role === 'user' ? 'You' : 'Assistant';
        const bodyHtml = role === 'assistant' ? renderMarkdown(content) : escapeHtml(content);
        div.innerHTML = '<span class="role">' + escapeHtml(label) + '</span><span class="body">' + bodyHtml + '</span>';
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      let conversationHistory = [];

      async function sendMessage() {
        const text = inputEl.value.trim();
        if (!text) return;
        inputEl.value = '';
        appendMessage('user', text);
        sendBtn.disabled = true;
        setProgressStep(0, 'Gathering context…');
        try {
          const res = await fetch('/api/chat/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text, history: conversationHistory })
          });
          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            setStatus(data.error || 'Request failed', true);
            appendMessage('assistant', data.error || 'Something went wrong.');
            return;
          }
          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            for (const line of lines) {
              if (!line.trim()) continue;
              try {
                const data = JSON.parse(line);
                if (data.event === 'status') {
                  const isOllama = data.message && data.message.includes('Ollama');
                  setProgressStep(isOllama ? 1 : 0, data.message || '');
                } else if (data.event === 'done') {
                  setStatus('');
                  progressStepsEl.style.display = 'none';
                  finishChatProgressList();
                  appendMessage('assistant', data.response || '');
                  if (Array.isArray(data.history)) conversationHistory = data.history;
                } else if (data.event === 'error') {
                  setStatus(data.error || 'Error', true);
                  finishChatProgressList();
                  appendMessage('assistant', data.error || 'Something went wrong.');
                }
              } catch (_) {}
            }
          }
          if (buffer.trim()) {
            try {
              const data = JSON.parse(buffer);
              if (data.event === 'done') {
                setStatus('');
                progressStepsEl.style.display = 'none';
                finishChatProgressList();
                appendMessage('assistant', data.response || '');
                if (Array.isArray(data.history)) conversationHistory = data.history;
              } else if (data.event === 'error') {
                setStatus(data.error || 'Error', true);
                appendMessage('assistant', data.error || 'Something went wrong.');
              }
            } catch (_) {}
          }
          setStatus('');
          progressStepsEl.style.display = 'none';
        } catch (e) {
          setStatus('Network error: ' + e.message, true);
          finishChatProgressList();
          appendMessage('assistant', 'Could not reach the server.');
        } finally {
          sendBtn.disabled = false;
        }
      }

      sendBtn.addEventListener('click', sendMessage);
      inputEl.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      const tabs = document.querySelectorAll('.tab');
      const panels = document.querySelectorAll('.panel');
      tabs.forEach(function(btn) {
        btn.addEventListener('click', function() {
          const tabId = btn.dataset.tab;
          tabs.forEach(function(b) {
            b.classList.remove('active');
            b.setAttribute('aria-selected', b === btn ? 'true' : 'false');
          });
          panels.forEach(function(p) {
            const isActive = p.id === 'panel-' + tabId;
            p.classList.toggle('active', isActive);
            p.hidden = !isActive;
          });
          btn.classList.add('active');
          btn.setAttribute('aria-selected', 'true');
        });
      });

      const reviewPathsEl = document.getElementById('reviewPaths');
      const reviewFocusEl = document.getElementById('reviewFocus');
      const runReviewBtn = document.getElementById('runReview');
      const reviewStatusEl = document.getElementById('reviewStatus');
      const reviewResultsEl = document.getElementById('reviewResults');
      const reviewStatusWrapEl = document.getElementById('reviewStatusWrap');
      const reviewResultsContainer = reviewResultsEl.querySelector('.container');
      const reviewProgressLogEl = document.getElementById('reviewProgressLog');
      const reviewSidePanelEl = document.getElementById('reviewSidePanel');

      function addReviewProgressStep(label, state, detail) {
        reviewProgressLogEl.hidden = false;
        reviewSidePanelEl.setAttribute('data-has-steps', 'true');
        var li = document.createElement('li');
        li.className = 'review-progress-step ' + (state || 'active');
        var icon = '<span class="icon">' + (state === 'done' ? '<span class="check">✓</span>' : '<span class="spinner"></span>') + '</span>';
        var text = '<span class="label">' + escapeHtml(label) + '</span>';
        if (detail) text += '<span class="detail">' + escapeHtml(detail) + '</span>';
        li.innerHTML = icon + text;
        reviewProgressLogEl.appendChild(li);
      }

      function markLastReviewStepDone(detail) {
        var last = reviewProgressLogEl.querySelector('.review-progress-step.active');
        if (!last) return;
        last.classList.remove('active');
        last.classList.add('done');
        last.querySelector('.icon').innerHTML = '<span class="check">✓</span>';
        if (detail) {
          var d = last.querySelector('.detail');
          if (d) d.textContent = detail;
          else {
            var span = document.createElement('span');
            span.className = 'detail';
            span.textContent = detail;
            last.appendChild(span);
          }
        }
      }

      function setReviewStatus(text, isError) {
        reviewStatusEl.innerHTML = text ? escapeHtml(text) : '';
        reviewStatusEl.className = 'status status-text' + (isError ? ' error' : '');
        reviewStatusEl.style.display = text ? 'flex' : 'none';
        if (text && !isError) {
          reviewStatusWrapEl.classList.add('in-progress');
          reviewStatusWrapEl.style.display = 'flex';
        } else {
          reviewStatusWrapEl.classList.remove('in-progress');
          reviewStatusWrapEl.style.display = text ? 'flex' : 'none';
        }
      }

      async function runReview() {
        const pathsStr = reviewPathsEl.value.trim();
        const paths = pathsStr ? pathsStr.split(/\s*,\s*/).map(function(s) { return s.trim(); }).filter(Boolean) : [];
        const focus = reviewFocusEl.value.trim();
        runReviewBtn.disabled = true;
        reviewResultsContainer.innerHTML = '';
        reviewProgressLogEl.innerHTML = '';
        reviewProgressLogEl.hidden = true;
        reviewSidePanelEl.removeAttribute('data-has-steps');
        setReviewStatus('Starting code review…');
        addReviewProgressStep('Starting code review…', 'active');
        try {
          const res = await fetch('/api/review/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paths: paths, focus: focus })
          });
          if (!res.ok) {
            const data = await res.json().catch(function() { return {}; });
            setReviewStatus(data.error || 'Request failed', true);
            return;
          }
          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let summary = '';
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            for (const line of lines) {
              if (!line.trim()) continue;
              try {
                const data = JSON.parse(line);
                if (data.event === 'status') {
                  var msg = data.message || '';
                  setReviewStatus(msg);
                  if (msg.indexOf('Starting') !== -1) {
                    /* first step already added when review started */
                  } else if (msg.indexOf('Planning') !== -1) {
                    markLastReviewStepDone();
                    addReviewProgressStep(msg, 'active');
                  } else if (msg.indexOf('Summarizing') !== -1) {
                    markLastReviewStepDone();
                    addReviewProgressStep('Summarizing…', 'active');
                  } else if (msg) {
                    markLastReviewStepDone();
                    addReviewProgressStep(msg, 'active');
                  }
                } else if (data.event === 'review_file') {
                  markLastReviewStepDone();
                  setReviewStatus('Reviewing ' + (data.path || '') + '…');
                  addReviewProgressStep('Reviewing ' + (data.path || ''), 'active');
                } else if (data.event === 'findings') {
                  var count = (data.findings && data.findings.length) ? data.findings.length : 0;
                  markLastReviewStepDone(count ? count + ' findings' : null);
                  (data.findings || []).forEach(function(f) {
                    const div = document.createElement('div');
                    div.className = 'review-finding ' + (f.severity || 'suggestion');
                    div.innerHTML = '<span class="path">' + escapeHtml(f.file || '') + (f.line ? ':' + f.line : '') + '</span> <span class="rule">' + escapeHtml(f.rule || '') + '</span> ' + escapeHtml(f.message || '');
                    reviewResultsContainer.appendChild(div);
                  });
                } else if (data.event === 'summary') {
                  summary = data.summary || '';
                  markLastReviewStepDone();
                  var sumDiv = document.createElement('div');
                  sumDiv.className = 'review-summary';
                  sumDiv.textContent = summary;
                  reviewResultsContainer.insertBefore(sumDiv, reviewResultsContainer.firstChild);
                } else if (data.event === 'done') {
                  markLastReviewStepDone();
                  addReviewProgressStep('Done', 'done');
                  setReviewStatus('');
                  if (data.summary && !summary) {
                    const sumDiv = document.createElement('div');
                    sumDiv.className = 'review-summary';
                    sumDiv.textContent = data.summary;
                    reviewResultsContainer.insertBefore(sumDiv, reviewResultsContainer.firstChild);
                  }
                } else if (data.event === 'error') {
                  markLastReviewStepDone();
                  addReviewProgressStep('Error: ' + (data.error || 'Error'), 'done');
                  setReviewStatus(data.error || 'Error', true);
                }
              } catch (_) {}
            }
          }
        if (buffer.trim()) {
          try {
            const data = JSON.parse(buffer);
            if (data.event === 'done') {
              markLastReviewStepDone();
              addReviewProgressStep('Done', 'done');
              if (data.summary) {
                var sumDiv = document.createElement('div');
                sumDiv.className = 'review-summary';
                sumDiv.textContent = data.summary;
                reviewResultsContainer.insertBefore(sumDiv, reviewResultsContainer.firstChild);
              }
            } else if (data.event === 'error') {
              markLastReviewStepDone();
              addReviewProgressStep('Error: ' + (data.error || 'Error'), 'done');
              setReviewStatus(data.error || 'Error', true);
            }
          } catch (_) {}
        }
        setReviewStatus('');
        } catch (e) {
          setReviewStatus('Network error: ' + e.message, true);
        } finally {
          runReviewBtn.disabled = false;
        }
      }

      runReviewBtn.addEventListener('click', runReview);
    })();
  </script>
</body>
</html>
